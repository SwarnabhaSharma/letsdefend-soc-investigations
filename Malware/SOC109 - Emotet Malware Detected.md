# SOC Alert Investigation

## 1. Alert Overview
- **Platform:** LetsDefend SOC Environment
- **Alert Name / ID:** SOC109 - Emotet Malware Detected
- **Event ID:** 85
- **Category:** Malware
- **Severity:** Medium
- **Date & Time:** Mar, 22, 2021, 09:06 PM
- **MITRE ATT&CK (if applicable):**
  - [T1566.001 – Phishing: Spearphishing Attachment](https://attack.mitre.org/techniques/T1566/001/) *(initial access via malicious `1word.doc` email attachment)*
  - [T1204.002 – User Execution: Malicious File](https://attack.mitre.org/techniques/T1204/002/) *(user opened the document and enabled macros)*
  - [T1027 – Obfuscated Files or Information](https://attack.mitre.org/techniques/T1027/) *(Emotet uses heavily obfuscated VBA macros and PowerShell scripts)*
  - [T1059.001 – Command and Scripting Interpreter: PowerShell](https://attack.mitre.org/techniques/T1059/001/) *(macro spawns PowerShell to download Emotet payload DLL)*
  - [T1055.001 – Process Injection: DLL Injection](https://attack.mitre.org/techniques/T1055/001/) *(Emotet injects malicious DLL into legitimate processes like `explorer.exe`)*
  - [T1547.001 – Boot or Logon Autostart Execution: Registry Run Keys](https://attack.mitre.org/techniques/T1547/001/) *(Emotet persists via `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`)*
  - [T1057 – Process Discovery](https://attack.mitre.org/techniques/T1057/) *(Emotet enumerates running processes)*
  - [T1082 – System Information Discovery](https://attack.mitre.org/techniques/T1082/) *(Emotet collects OS/network info for C2 reporting)*
  - [T1083 – File and Directory Discovery](https://attack.mitre.org/techniques/T1083/) *(Emotet searches for credentials and sensitive files)*

**Description:**  
The endpoint security solution on host `RichardPRD` (IP: `172.16.17.45`) detected a malicious Word document named `1word.doc` (MD5: `349d13ca99ab03869548d75b99e5a1d0`, SHA256: `d34849e1c97f9e615b3a9b800ca1f11ed04a92b1014f55aa0158e3fffc22d78f`). The file was confirmed by VirusTotal as **Emotet malware** — a highly sophisticated, modular Trojan and Malware-as-a-Service (MaaS) platform. The document contains obfuscated VBA macros that, when executed, spawn a PowerShell process to download and deploy the Emotet DLL payload. Device action is **Cleaned**, meaning the endpoint security agent detected and attempted to quarantine/remove the file. Despite the cleaned status, this is a confirmed **True Positive** requiring full incident response — the macro may have already executed before remediation, and Emotet's multi-stage infection chain and persistence mechanisms require thorough verification.

---

## 2. Initial Analysis

- **Attacker IP:** N/A (initial access via phishing email — no direct attacker IP in this alert)
- **Host IP:** 172.16.17.45
- **Hostname / User:** RichardPRD
- **Relevant Logs / Indicators:**
  - **File Name:** `1word.doc`
  - **MD5 Hash:** `349d13ca99ab03869548d75b99e5a1d0`
  - **SHA256 Hash:** `d34849e1c97f9e615b3a9b800ca1f11ed04a92b1014f55aa0158e3fffc22d78f`
  - **File Size:** 188.95 KB
  - **Device Action:** Cleaned (endpoint AV detected and attempted remediation)
  - **File Type:** Microsoft Word Document (`.doc`) with embedded obfuscated VBA macros
  - **Infection Chain:** `1word.doc` → Enable Macros → Obfuscated VBA → PowerShell (encoded command) → Download Emotet DLL → `explorer.exe` process injection → C2 communication + persistence

---

## 3. Investigation Steps

- **Step 1 – Alert Triage:** 
  Reviewed alert metadata: triggered on `RichardPRD` (`172.16.17.45`) at 9:06 PM on Mar 22, 2021. The flagged file is `1word.doc`, a `.doc` file — a known Emotet delivery format. Device action was **Cleaned**, meaning detection occurred, but this does not guarantee the macro did not execute before remediation. Severity is **Medium**; however, Emotet's Malware-as-a-Service nature and capability to drop secondary payloads (TrickBot, Qbot, ransomware) makes this a high-priority investigation. User `RichardPRD` likely received this file as a phishing email attachment.

- **Step 2 – File Hash Analysis (VirusTotal):**  
  Submitted the SHA256 hash `d34849e1c97f9e615b3a9b800ca1f11ed04a92b1014f55aa0158e3fffc22d78f` to VirusTotal.  
  Result: **Flagged as malicious by multiple AV engines** — confirmed as **Emotet**. Vendors identify it as `Trojan-Banker.Win32.Emotet`, `W97M.Emotet`, `Trojan.GenericKD.Emotet`, and similar. The file contains obfuscated VBA macros that initiate a PowerShell download chain.  
  [VT Report](https://www.virustotal.com/gui/file/d34849e1c97f9e615b3a9b800ca1f11ed04a92b1014f55aa0158e3fffc22d78f)

- **Step 3 – File Hash Analysis (MD5 Cross-Reference):**  
  Cross-referenced MD5 `349d13ca99ab03869548d75b99e5a1d0` on threat intelligence platforms (IBM X-Force, AbuseIPDB). Result: **Confirmed malicious** — matches known Emotet document samples. File is a Microsoft Word `.doc` document weaponized with obfuscated VBA macros consistent with Emotet's dropper behavior.

- **Step 4 – Macro & Behavior Analysis (Sandbox):**  
  Reviewed dynamic analysis of the `1word.doc` file type in sandbox environments (Any.run / Hybrid Analysis). When macros are enabled by the user, the following infection chain is observed:
  1. Heavily obfuscated VBA macro executes
  2. Macro constructs and invokes an obfuscated PowerShell command (often via `-EncodedCommand`)
  3. PowerShell iterates through a hardcoded list of URLs to download the Emotet DLL payload
  4. Downloaded DLL is executed (often via `regsvr32.exe` or direct `rundll32.exe`)
  5. DLL injects into `explorer.exe` for stealth and establishes C2 communication
  6. Persistence set via registry run key: `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
  7. Emotet begins credential harvesting, email address scraping (Outlook), and may download secondary payloads (TrickBot, Qbot)

- **Step 5 – Endpoint Activity Review (RichardPRD):**  
  Reviewed endpoint telemetry on `RichardPRD` (`172.16.17.45`). Key questions investigated:
  - Was `WINWORD.EXE` the parent process that spawned `powershell.exe`? *(Highly suspicious; expected in Emotet infection)*
  - Were any DLLs dropped in `AppData\Local` or `AppData\Roaming` with random names?
  - Were registry run keys modified under `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`?
  - Were any scheduled tasks created?
  - Was `explorer.exe` showing unusual memory activity consistent with DLL injection?
  The device action "Cleaned" may mean the `.doc` file was quarantined, but if macros executed even briefly before cleanup, the PowerShell stage may have already downloaded and run the Emotet DLL — which could persist independently.

- **Step 6 – Log Management Review:**  
  Searched log management for outbound connections from `RichardPRD` (`172.16.17.45`) around 9:06 PM on Mar 22, 2021. In the LetsDefend simulation, **no confirmed successful C2 communication** was observed in the logs — consistent with the endpoint AV having cleaned the file before the PowerShell payload fully executed and established C2. However, attempted outbound connections by PowerShell to Emotet's dynamically rotated C2 IP pool (typically ports 80, 443, 7080, 8080) should be checked. The absence of successful C2 logs does not guarantee no partial execution occurred.

- **Step 7 – Verdict Determination:**  
  Based on all evidence — confirmed Emotet detection on VirusTotal with multiple AV engine hits, known Emotet document behavior (obfuscated VBA → PowerShell → DLL), file quarantined by AV (Cleaned), and no confirmed successful C2 despite the alert — this is a **True Positive**. The threat was detected and contained by the endpoint agent, but thorough host inspection and threat hunting are required to confirm no persistence or secondary payload was deployed before cleanup.

---

## 4. Findings & Evidence

- **VirusTotal (SHA256):** Flagged as malicious — Emotet (W97M.Emotet / Trojan-Banker.Emotet)  
  [https://www.virustotal.com/gui/file/d34849e1c97f9e615b3a9b800ca1f11ed04a92b1014f55aa0158e3fffc22d78f](https://www.virustotal.com/gui/file/d34849e1c97f9e615b3a9b800ca1f11ed04a92b1014f55aa0158e3fffc22d78f)
- **MD5 Cross-Reference:** `349d13ca99ab03869548d75b99e5a1d0` confirmed as Emotet maldoc on IBM X-Force / AbuseIPDB
- **File Type:** Word `.doc` with obfuscated VBA macros — classic Emotet delivery mechanism
- **Sandbox Behavior (Known):** VBA macro → obfuscated PowerShell `-EncodedCommand` → multi-URL DLL download → `explorer.exe` injection → C2 → credential theft + email harvesting
- **Device Action:** `Cleaned` — endpoint AV quarantined `1word.doc`; however, macro execution window before cleanup cannot be ruled out
- **Log Management:** No confirmed successful outbound C2 connections from `172.16.17.45` at time of alert — suggests AV intervened early in the infection chain
- **Delivery Vector (Assessed):** Phishing email to user `RichardPRD` with `1word.doc` attachment — consistent with Emotet's primary distribution method (malspam / thread hijacking)

---

## 5. Incident Classification
- **Final Verdict:** True Positive
- **Attack Stage:** Initial Access → Execution (macro triggered) / Delivery (AV cleaned before full C2 establishment)
- **Attack Vector:** Phishing email with malicious Word document attachment (`1word.doc`) — user likely prompted to enable macros (social engineering lure)
- **Malware Type:** Banking Trojan / Modular Downloader / Botnet (Emotet — Malware-as-a-Service platform)
- **Impact:** Contained — endpoint AV ("Cleaned") likely prevented full C2 establishment and secondary payload delivery. However, credential theft or email harvesting may have occurred in the window before remediation. Lateral movement risk is present if containment was incomplete.

---

## 6. Response & Mitigation

- **Immediate Containment:**
  Isolate `RichardPRD` (`172.16.17.45`) from the network immediately as a precautionary measure, even though the device action shows "Cleaned." Emotet's multi-stage infection chain means the DLL payload may have already been downloaded and injected before the AV quarantined the `.doc` file. Use EDR/NAC to contain the host and prevent potential lateral movement via SMB or credential-based propagation.

- **Indicator Blocking:**
  - Add MD5 `349d13ca99ab03869548d75b99e5a1d0` and SHA256 `d34849e1c97f9e615b3a9b800ca1f11ed04a92b1014f55aa0158e3fffc22d78f` to the EDR/AV blocklist
  - Block any identified Emotet C2 IPs at the firewall (reference Abuse.ch Feodo Tracker for current Emotet C2 IP blocklists)
  - Block outbound PowerShell to internet-facing IPs at the proxy/NGFW level (if not already restricted)
  - Consider blocking macro execution in Word documents received from external email sources via Group Policy (`HKCU\Software\Policies\Microsoft\Office\*\Word\Security\VBAWarnings = 4`)

- **Credential Reset:** 
  Reset credentials for user `RichardPRD` immediately. Emotet is known to harvest browser-stored credentials (Chrome, Firefox, IE), Windows credential stores, and Outlook email accounts. Assume all local credentials on the host are potentially compromised. If domain credentials were used on `RichardPRD`, escalate to Active Directory-wide credential review.

- **Malware Removal & Host Remediation:** 
  1. Verify that the "Cleaned" action fully removed `1word.doc` and check for any dropped DLL artifacts in `AppData\Local`, `AppData\Roaming`, or `Temp` directories
  2. Inspect registry key `HKCU\Software\Microsoft\Windows\CurrentVersion\Run` for any Emotet persistence entries and remove them
  3. Check for and remove any suspiciously named scheduled tasks created around the alert time
  4. Scan for injected processes — review `explorer.exe` and other common targets for malicious DLL injections
  5. If any persistence or secondary payload is found, **wipe and reimage** `RichardPRD` from a known-good backup
  6. Verify email client (Outlook) is clean — Emotet scrapes Outlook for email addresses to fuel future malspam campaigns and may have hijacked email threads

- **Threat Hunt:** 
  Conduct a network-wide threat hunt for Emotet lateral spread and additional infections:
  - Search all endpoint logs for `WINWORD.EXE` spawning `powershell.exe`, `cmd.exe`, `wscript.exe`, or `cscript.exe` — this parent-child relationship is a high-fidelity Emotet indicator
  - Hunt for PowerShell executing with `-EncodedCommand` or `-WindowStyle Hidden` parameters across all endpoints
  - Search for files named `1word.doc` or matching the MD5/SHA256 hashes across the entire environment
  - Check for Emotet-related registry run key artifacts (`HKCU\Software\Microsoft\Windows\CurrentVersion\Run`) on all domain systems
  - Review SMB traffic and authentication logs for brute-force attempts or unusual lateral connections originating from `172.16.17.45`
  - Review all email gateway logs for `1word.doc` or similar Emotet maldoc attachments delivered to other users (potential wider campaign)

- **IOC Sharing:** 
  Share the following IOCs with the threat intelligence community via MISP, VirusTotal, or relevant ISACs:
  - MD5: `349d13ca99ab03869548d75b99e5a1d0`
  - SHA256: `d34849e1c97f9e615b3a9b800ca1f11ed04a92b1014f55aa0158e3fffc22d78f`
  - Filename: `1word.doc`
  - Malware Family: Emotet

---

## 7. Lessons Learned

- **"Device Action: Cleaned" does NOT mean the incident is over.** Emotet's multi-stage infection chain means that even if the `.doc` file is quarantined, the obfuscated VBA macro may have already spawned a PowerShell process that downloaded the Emotet DLL payload. A "Cleaned" AV action addresses only the initial file — any dropped DLLs, registry persistence, process injections, or secondary payloads must be independently verified and removed. Treating "Cleaned" as case-closed is a critical mistake with Emotet.
- **Obfuscated macro documents demand sandbox analysis.** Emotet's heavy reliance on obfuscated VBA → PowerShell delivery chains makes static analysis alone insufficient. Dynamic sandbox analysis (Any.run, Hybrid Analysis) is essential for understanding the full scope of the infection chain and identifying download URLs, C2 IPs, and dropped artifacts that may not appear in static file properties.
- **Emotet is a Malware-as-a-Service loader — the real danger is what comes next.** Emotet's primary role in 2021 was acting as a gateway for secondary payloads: TrickBot, Qbot, IcedID, and ultimately ransomware families like Ryuk and Conti. A contained Emotet infection averts the immediate threat, but the risk of secondary deployment (if any window of execution existed) makes this a critical-severity incident in practice, despite the "Medium" alert severity label.
- **PowerShell execution from Office processes is a high-signal indicator.** The process chain `WINWORD.EXE → powershell.exe` (especially with `-EncodedCommand` or `-WindowStyle Hidden`) is one of the most reliable indicators of malicious macro execution. Endpoint rules that alert on this parent-child relationship — regardless of what the Word document contains — would have elevated alert priority significantly faster.
- **Email gateway controls are the first line of defense against Emotet.** Since `1word.doc` was delivered via phishing email, configuring the email gateway to strip `.doc`, `.xls`, and other macro-capable Office file types from external email — or sandboxing them before delivery — would have prevented the file from ever reaching the user's inbox. Proactive email filtering is far more efficient than reactive endpoint detection.
- **User education on macro security is critical.** Emotet's infection chain requires the user to click "Enable Content" (macros). Training users to never enable macros in documents received via email — and to verify with IT before doing so — is a high-impact, low-cost defense against Emotet and similar macro-based malware.

---

## Indicators of Compromise (IOCs)

| Type | Value |
|---|---|
| Sender Email | N/A (not captured in alert — should be retrieved from email gateway logs) |
| Sender Domain | N/A (not captured in alert — likely a compromised legitimate domain per Emotet thread-hijacking) |
| SMTP Relay IP | N/A (not captured in this alert) |
| C2 IP | N/A (no successful C2 communication confirmed in logs; reference Feodo Tracker for Emotet C2 blocklist) |
| C2 Port | 80, 443, 7080, 8080 (Emotet commonly uses these ports for C2) |
| Attachment Name | `1word.doc` |
| Malware Name | Emotet (W97M.Emotet / Trojan-Banker.Win32.Emotet) |
| MD5 Hash | `349d13ca99ab03869548d75b99e5a1d0` |
| SHA256 Hash | `d34849e1c97f9e615b3a9b800ca1f11ed04a92b1014f55aa0158e3fffc22d78f` |
| Malware Family | Emotet (a.k.a. Heodo, Geodo) |
| Mutex | N/A (not captured in this alert) |
| Persistence Path | `HKCU\Software\Microsoft\Windows\CurrentVersion\Run` (Emotet registry persistence) |
| Victim Host IP | `172.16.17.45` |
| Victim User | `RichardPRD` |

---

## Notes
- Environment: Simulated SOC / Lab Environment
- This investigation was conducted for learning and skill development purposes.
