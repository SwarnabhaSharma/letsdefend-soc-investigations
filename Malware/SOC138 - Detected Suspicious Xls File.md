# SOC Alert Investigation

## 1. Alert Overview
- **Platform:** LetsDefend SOC Environment
- **Alert Name / ID:** SOC138 - Detected Suspicious Xls File
- **Event ID:** 77
- **Category:** Malware
- **Severity:** Medium
- **Date & Time:** Mar, 13, 2021, 08:20 PM
- **MITRE ATT&CK (if applicable):**
  - T1566.001 – Initial Access – Phishing: Spearphishing Attachment
  - T1203 – Execution – Exploitation for Client Execution (CVE-2017-11882)
  - T1059.001 – Execution – Command and Scripting Interpreter: PowerShell
  - T1112 – Defense Evasion – Modify Registry
  - T1071.001 – Command and Control – Application Layer Protocol: Web Protocols

**Description:**  
A phishing email carrying a malicious macro-enabled Excel file (`ORDER SHEET & SPEC.xlsm`) was delivered and **executed** on the endpoint `Sofia` (172.16.17.56). The file exploited CVE-2017-11882 (Microsoft Equation Editor memory corruption vulnerability) to launch a PowerShell-based downloader. The payload established outbound C2 communication to `177.53.143.89` over port 443. The device action was **Allowed** — the file was not quarantined and the malware ran successfully.

---

## 2. Initial Analysis

- **Attacker IP:** 177.53.143.89 (C2 Server — Brazil, AS 28338)
- **Host IP:** 172.16.17.56
- **Hostname / User:** Sofia
- **Relevant Logs / Indicators:**
  - File Name: `ORDER SHEET & SPEC.xlsm`
  - MD5 Hash: `7ccf88c0bbe3b29bf19d877c4596a8d4`
  - SHA256 Hash: `7bcd31bd41686c32663c7cabf42b18c50399e3b3b4533fc2ff002d9f2e058813`
  - File Size: 2.66 MB
  - File Type: Excel macro-enabled workbook (.xlsm) — Excel 4.0 Macro (XLM)
  - Device Action: Allowed (Not Quarantined — file was executed)
  - File (Password: infected): https://download.cyberlearn.academy/download/download?url=https://files-ld.s3.us-east-2.amazonaws.com/7ccf88c0bbe3b29bf19d877c4596a8d4.zip

---

## 3. Investigation Steps

- **Step 1 – Alert Triage:**  
  Reviewed the alert triggered for EventID 77. The detection rule flagged a phishing email with an Excel 4.0 macro-enabled attachment delivered to user `Sofia` on host `172.16.17.56`. Device action was Allowed, meaning the file landed on the endpoint. The attacker IP `177.53.143.89` was already flagged in the alert header — this matches the confirmed C2 server. Severity is Medium, but C2 communication post-execution escalates the actual risk.

- **Step 2 – Static Analysis (VirusTotal):**  
  Submitted both the MD5 and SHA256 hashes to VirusTotal.  
  - **Result:** 40+ security vendors flagged the file as malicious.  
  - Tags: `auto-open`, `run-file`, `writes-files`, `calls-wmi`, macro-obfuscation, exploit attempt.  
  - CVE-2017-11882 (Equation Editor exploit) confirmed.  
  - The file abuses Excel 4.0 macros to run obfuscated scripts targeting `%USERPROFILE%` and leveraging `Win32_Process` (WMI).  
  - VirusTotal URL: https://www.virustotal.com/gui/url/711b0adde54d737b4881dcd766d9fb6d18b89fe7b2a4d1921bf534fb6caa096b

- **Step 3 – Dynamic Analysis (ANY.RUN Sandbox):**  
  Detonated the file in a sandboxed environment via ANY.RUN.  
  - **Result:** Confirmed malicious — classified as a phishing document / macro downloader.  
  - The macro triggered `EXCEL.EXE` to spawn `cmd.exe` and then `powershell.exe`.  
  - PowerShell executed an encoded command using `System.Net.WebClient` with `ServicePointManager.SecurityProtocol` to download a follow-on payload.  
  - An outbound HTTPS connection was made to `177.53.143.89:443` (C2 domain: `multiwaretecnologia.com.br`).  
  - Registry modification observed consistent with MITRE T1112 (persistence).  
  - Alternative Data Streams (AltDS) usage detected.

- **Step 4 – Log Correlation (Firewall & Endpoint Logs):**  
  - **Firewall Logs:** Confirmed outbound connections from `172.16.17.56` → `177.53.143.89` over **port 443**.  
  - **Endpoint Logs:** `EXCEL.EXE` spawning `cmd.exe` → `powershell.exe` — a clear indicator of malicious macro execution. Registry write events also logged, pointing to persistence activity.  
  - Network communication confirms the host is **actively compromised** and beaconing to the C2.

- **Step 5 – Threat Intelligence Lookup:**  
  - IP `177.53.143.89` is geolocated to **Brazil** and is attributed to C2 infrastructure.  
  - Domain `multiwaretecnologia.com.br` is a known malicious C2 domain linked to this campaign.  
  - Multiple threat intel sources (abuse.ch, VirusTotal, ANY.RUN) corroborate this as a **macro-based downloader** campaign, potentially distributing **Agent Tesla** or a similar infostealer.

---

## 4. Findings & Evidence

- **VirusTotal Analysis:** https://www.virustotal.com/gui/url/711b0adde54d737b4881dcd766d9fb6d18b89fe7b2a4d1921bf534fb6caa096b  
  → 40+ detections; confirmed exploit of CVE-2017-11882; Excel 4.0 macro abuse.

- **ANY.RUN Sandbox Analysis:**  
  → Macro triggered PowerShell downloader; C2 callback to `177.53.143.89:443`; registry modifications for persistence.

- **Firewall Logs:**  
  → Victim host `172.16.17.56` made outbound connection to `177.53.143.89` over port 443 — **confirmed C2 communication**.

- **Endpoint (EDR) Logs:**  
  → Suspicious process chain: `EXCEL.EXE → cmd.exe → powershell.exe`; registry modification events.

- **Key Conclusions:**  
  - The file was executed (device action: Allowed).
  - CVE-2017-11882 exploited for initial execution.
  - Macro-delivered PowerShell downloader connected to C2.
  - Host `Sofia` is actively compromised — **True Positive**.

---

## 5. Incident Classification
- **Final Verdict:** ✅ True Positive — Malware (Macro-Based Downloader / Infostealer)
- **Attack Stage:** Execution → C2 Communication (Kill Chain: Weaponization → Delivery → Exploitation → Installation → C2)
- **Attack Vector:** Phishing Email with Malicious Macro-Enabled Excel Attachment (.xlsm)
- **Malware Type:** Macro-based downloader exploiting CVE-2017-11882 (Equation Editor); consistent with Agent Tesla / infostealer family delivery
- **Impact:** Host fully compromised; active C2 channel established; potential data exfiltration, credential theft, and lateral movement risk

---

## 6. Response & Mitigation

- **Immediate Containment:**  
  Isolate host `Sofia` (172.16.17.56) from the network immediately to cut C2 communication. Disable the user's active sessions and prevent access to shared resources until remediation is complete.

- **Indicator Blocking:**  
  - Block IP `177.53.143.89` at the perimeter firewall / NGFW.
  - Block domain `multiwaretecnologia.com.br` on DNS resolver / web proxy.
  - Block file hash `7ccf88c0bbe3b29bf19d877c4596a8d4` (MD5) and `7bcd31bd41686c32663c7cabf42b18c50399e3b3b4533fc2ff002d9f2e058813` (SHA256) in EDR and email gateway.
  - Block all `.xlsm` / macro-enabled attachments from external senders at the email gateway.

- **Credential Reset:**  
  Reset credentials for user `Sofia` and any other accounts that were active on the compromised host. Assume credentials may have been captured by the infostealer payload.

- **Malware Removal & Host Remediation:**  
  - Perform a full AV/EDR scan on the affected host.
  - Review and remove any registry persistence keys added by the malware.
  - Reimage the host if stealer payload successfully exfiltrated credentials or if persistence is deeply embedded.
  - Search for any dropped secondary payloads on disk, particularly in `%USERPROFILE%`, `%APPDATA%`, and `%TEMP%` directories.

- **Threat Hunt:**  
  - Hunt across all endpoints for the same process chain: `EXCEL.EXE → cmd.exe → powershell.exe`.
  - Search for outbound connections to `177.53.143.89` and `multiwaretecnologia.com.br` in firewall/proxy logs.
  - Hunt for CVE-2017-11882 exploitation patterns (Equation Editor spawning child processes) across all hosts.
  - Search email gateway logs for other recipients of the same phishing campaign — cross-reference the sender email from the detection rule.

- **IOC Sharing:**  
  Share the following IOCs with the team / threat intel platform:
  - IP: `177.53.143.89`
  - Domain: `multiwaretecnologia.com.br`
  - MD5: `7ccf88c0bbe3b29bf19d877c4596a8d4`
  - SHA256: `7bcd31bd41686c32663c7cabf42b18c50399e3b3b4533fc2ff002d9f2e058813`
  - CVE: CVE-2017-11882

---

## 7. Lessons Learned

- **Macro-enabled Office files remain a high-risk delivery vehicle.** The organization should enforce Group Policy to disable macros from internet-sourced files (Protected View bypass was likely involved here).
- **CVE-2017-11882 (Equation Editor) is a well-known, patched vulnerability from 2017.** The fact that it was exploited here suggests the endpoint may have been running an unpatched version of Microsoft Office — patching cadence should be reviewed.
- **Device Action "Allowed" is a high-risk indicator.** The email gateway / DLP system did not block or quarantine the file. Controls should be tuned to block `.xlsm` and other macro-enabled formats from external sources.
- **The anomalous process chain (Excel → cmd → PowerShell) should have triggered an EDR behavioral alert.** If it did not, EDR detection rules should be reviewed and hardened.
- **Rapid triage to containment is critical.** C2 communication was already established by the time the alert was raised — faster automated containment policies (quarantine on malware detection) would reduce dwell time.

---

## Indicators of Compromise (IOCs)

| Type | Value |
|---|---|
| Sender Email | Detected via rule: *"Phishing mail detected - Excel 4.0 Macros"* (sender: `trenton` — exact address not captured in logs) |
| Sender Domain | External phishing sender (unknown domain) |
| SMTP Relay IP | Not captured in available logs |
| C2 IP | 177.53.143.89 |
| C2 Domain | multiwaretecnologia.com.br |
| C2 Port | 443 (HTTPS) |
| Attachment Name | ORDER SHEET & SPEC.xlsm |
| Malware Type | Macro-based downloader / Infostealer (Agent Tesla suspected) |
| MD5 Hash | 7ccf88c0bbe3b29bf19d877c4596a8d4 |
| SHA256 Hash | 7bcd31bd41686c32663c7cabf42b18c50399e3b3b4533fc2ff002d9f2e058813 |
| Malware Family | Excel 4.0 Macro Downloader / Agent Tesla (suspected) |
| Mutex | Not definitively identified in available analysis |
| Persistence Path | Registry modification (HKCU Run keys — exact path from sandbox analysis) |
| Victim Host IP | 172.16.17.56 |
| Victim User | Sofia |
| Exploit | CVE-2017-11882 (Microsoft Office Equation Editor) |

---

## Notes
- Environment: Simulated SOC / Lab Environment
- This investigation was conducted for learning and skill development purposes.
- Analysis corroborated by: VirusTotal, ANY.RUN sandbox, abuse.ch, and multiple public LetsDefend SOC138 writeups.
