# SOC Alert Investigation

## 1. Alert Overview
- **Platform:** LetsDefend SOC Environment
- **Alert Name / ID:** SOC104 - Malware Detected
- **Event ID:** 36
- **Category:** Malware
- **Severity:** High
- **Date & Time:** Dec, 01, 2020, 10:23 AM
- **MITRE ATT&CK (if applicable):**
  - [T1566 – Phishing](https://attack.mitre.org/techniques/T1566/) *(likely initial access vector — malware delivered as a malicious email attachment disguised as an invoice)*
  - [T1204.002 – User Execution: Malicious File](https://attack.mitre.org/techniques/T1204/002/) *(user executed `Invoice.exe` from a phishing email)*
  - [T1486 – Data Encrypted for Impact](https://attack.mitre.org/techniques/T1486/) *(Maze ransomware encrypts victim files using RSA + ChaCha20)*
  - [T1490 – Inhibit System Recovery](https://attack.mitre.org/techniques/T1490/) *(Maze deletes Volume Shadow Copies via WMI to prevent recovery)*
  - [T1041 – Exfiltration Over C2 Channel](https://attack.mitre.org/techniques/T1041/) *(data exfiltrated to C2 at `92.63.8.47` — Maze's double extortion tactic)*
  - [T1059 – Command and Scripting Interpreter](https://attack.mitre.org/techniques/T1059/) *(batch scripts and PowerShell leveraged during execution)*
  - [T1057 – Process Discovery](https://attack.mitre.org/techniques/T1057/) *(Maze enumerates running processes to identify targets)*
  - [T1518.001 – Software Discovery: Security Software Discovery](https://attack.mitre.org/techniques/T1518/001/) *(Maze checks for installed antivirus/security products)*

**Description:**  
The endpoint security solution on host `AdamPRD` (IP: `10.15.15.18`) flagged a file named `Invoice.exe` (MD5: `f83fb9ce6a83da58b20685c1d7e1e546`, SHA256: `e8a091a84dd2ea7ee429135ff48e9f48f7787637ccb79f6c3eb42f34588bc684`) as malicious. The device action was **Allowed** — the file was not quarantined or blocked by the endpoint agent. A suspicious outbound connection to the known Maze ransomware C2 IP `92.63.8.47` was also observed in log management. The alert was escalated to the SOC for analyst triage. Investigation confirmed this is **Maze Ransomware** — a double-extortion ransomware family that both encrypts files and exfiltrates sensitive data.

---

## 2. Initial Analysis

- **Attacker IP:** 92.63.8.47 (Known Maze Ransomware C2 Server)
- **Host IP:** 10.15.15.18
- **Hostname / User:** AdamPRD
- **Relevant Logs / Indicators:**
  - **File Name:** `Invoice.exe`
  - **MD5 Hash:** `f83fb9ce6a83da58b20685c1d7e1e546`
  - **SHA256 Hash:** `e8a091a84dd2ea7ee429135ff48e9f48f7787637ccb79f6c3eb42f34588bc684`
  - **File Size:** 473.00 KB
  - **Device Action:** Allowed (not quarantined — file executed successfully)
  - **C2 Communication:** Outbound HTTP POST requests observed from `10.15.15.18` → `92.63.8.47` (port 80/443)

---

## 3. Investigation Steps

- **Step 1 – Alert Triage:** 
  Reviewed alert metadata: triggered on `AdamPRD` (`10.15.15.18`) at 10:23 AM on Dec 01, 2020. The flagged file is `Invoice.exe`. Device action was **Allowed**, meaning the EDR/AV did not automatically block or quarantine the file. Severity is **High** — the file is potentially ransomware. Escalation and immediate investigation are warranted.

- **Step 2 – File Hash Analysis (VirusTotal):**  
  Submitted the SHA256 hash `e8a091a84dd2ea7ee429135ff48e9f48f7787637ccb79f6c3eb42f34588bc684` to VirusTotal. Result: **Flagged as malicious by multiple AV engines**. The file is consistently identified as **Maze Ransomware**. Vendors label it with detections including `Ransom.Maze`, `Trojan.Ransom.Maze`, and similar. Behaviors noted: file encryption, shadow-copy deletion, C2 communication.  
  [VT Report](https://www.virustotal.com/gui/file/e8a091a84dd2ea7ee429135ff48e9f48f7787637ccb79f6c3eb42f34588bc684/detection)

- **Step 3 – File Hash Analysis (Any.run / Hybrid Analysis):**  
  Dynamic sandbox analysis of `Invoice.exe` confirms Maze ransomware behavior:
  - Attempts to enumerate running processes and installed AV software
  - Accesses and attempts to steal browser data (Chrome profile/cookies)
  - Makes outbound HTTP POST requests to `92.63.8.47:80` (hardcoded Maze C2 IP)
  - Modifies registry for potential persistence
  - Deletes Volume Shadow Copies using WMI (`vssadmin delete shadows`)
  - Drops ransom note files across the file system

- **Step 4 – C2 IP Reputation Check:**  
  Queried the IP `92.63.8.47` on threat intelligence platforms (VirusTotal, AbuseIPDB, Pulsedive). Result: **Confirmed malicious**. The IP is one of 14 hardcoded C2 addresses used by Maze ransomware, communicating over HTTP/HTTPS. Multiple sources link this IP directly to active Maze ransomware campaigns from 2020.

- **Step 5 – Log Management Review:**  
  Searched log management for the host IP `10.15.15.18` around the alert time on Dec 01, 2020. **Suspicious outbound connections confirmed** from `AdamPRD` to `92.63.8.47` via HTTP POST. This validates active C2 communication, confirming that `Invoice.exe` successfully executed and established a callback to the Maze ransomware infrastructure.

- **Step 6 – Endpoint Activity Review:**  
  Reviewed endpoint telemetry on `AdamPRD`. File `Invoice.exe` was executed by the user (likely opened from a phishing email). No process tree shows `Invoice.exe` spawning legitimate child processes — consistent with standalone ransomware execution. The file ran from a user download/temp path, not a system directory, indicating it was externally delivered (e.g., email attachment).

- **Step 7 – Verdict Determination:**  
  Based on all evidence — multiple AV detections on VirusTotal, confirmed Maze ransomware behavioral indicators in sandbox, active C2 communication to `92.63.8.47` confirmed in log management, and device action `Allowed` (file executed) — this alert is assessed as a **True Positive**. The host `AdamPRD` is actively infected with **Maze Ransomware**.

---

## 4. Findings & Evidence

- **VirusTotal (SHA256):** Flagged as malicious — Maze Ransomware  
  [https://www.virustotal.com/gui/file/e8a091a84dd2ea7ee429135ff48e9f48f7787637ccb79f6c3eb42f34588bc684/detection](https://www.virustotal.com/gui/file/e8a091a84dd2ea7ee429135ff48e9f48f7787637ccb79f6c3eb42f34588bc684/detection)
- **Sandbox Analysis (Any.run):** Confirmed ransomware behaviors — process enumeration, AV checks, Chrome data access, C2 POST requests to `92.63.8.47:80`, shadow copy deletion, ransom note drop
- **C2 IP `92.63.8.47`:** Listed as a known Maze ransomware hardcoded C2 server — confirmed malicious on VirusTotal, AbuseIPDB, and Pulsedive
- **Log Management:** Outbound HTTP POST connections from `10.15.15.18` to `92.63.8.47` observed at the time of infection — confirms active C2 beacon
- **Device Action:** `Allowed` — `Invoice.exe` was executed successfully; no automatic quarantine occurred
- **File Path:** Delivered externally (likely via phishing email) and executed from a non-system user path

---

## 5. Incident Classification
- **Final Verdict:** True Positive
- **Attack Stage:** Execution → Command & Control → Impact (Ransomware Deployment)
- **Attack Vector:** Phishing Email with malicious executable attachment (`Invoice.exe`) — social engineering using an invoice lure
- **Malware Type:** Ransomware (Double Extortion)
- **Impact:** High — `Invoice.exe` (Maze Ransomware) executed on `AdamPRD`, established C2 communication, and likely began file encryption and data exfiltration. Potential for lateral movement if not contained immediately.

---

## 6. Response & Mitigation

- **Immediate Containment:**
  Isolate host `AdamPRD` (`10.15.15.18`) from the network immediately to prevent:
  - Further C2 communication with `92.63.8.47`
  - Lateral movement to other internal hosts
  - Continued file encryption and data exfiltration
  Use EDR/NAC to quarantine the endpoint. Disable the machine's network interface or move it to an isolated VLAN.

- **Indicator Blocking:**
  - Block C2 IP `92.63.8.47` at the firewall/perimeter and all internal security controls (NGFW, proxy, EDR)
  - Add file hash `f83fb9ce6a83da58b20685c1d7e1e546` (MD5) and `e8a091a84dd2ea7ee429135ff48e9f48f7787637ccb79f6c3eb42f34588bc684` (SHA256) to the EDR/AV blocklist
  - Block `Invoice.exe` as a filename pattern across all endpoints (if contextually safe)

- **Credential Reset:** 
  Reset credentials for the user `AdamPRD` immediately. Maze ransomware is known to harvest browser-stored credentials (Chrome) and can perform credential-based lateral movement using Mimikatz-style techniques. Assume all credentials on the host are compromised.

- **Malware Removal & Host Remediation:** 
  1. Do not attempt to decrypt or recover files on the infected host without professional assistance — Maze uses RSA + ChaCha20 encryption.
  2. Wipe and reimage `AdamPRD` from a known-good backup (pre-infection snapshot if available).
  3. Verify the integrity of all backups before restoring — Maze may have targeted cloud or network-attached backups.
  4. Check for and remove any persistence mechanisms (scheduled tasks named `Windows Update Security`, startup folder entries, registry run keys).

- **Threat Hunt:** 
  Initiate a network-wide threat hunt to identify potential lateral movement or additional compromised hosts:
  - Search all endpoint logs for connections to `92.63.8.47` across the entire network
  - Hunt for `Invoice.exe` or the associated file hashes on any other hosts
  - Look for Volume Shadow Copy deletion events (`vssadmin`, WMI queries) across all endpoints
  - Search for unusual file encryption patterns (mass `.maze` or unusual extension file creation events)
  - Check for Mimikatz-related artifacts or LSASS access events on all domain-joined systems

- **IOC Sharing:** 
  Share the following IOCs with the wider threat intelligence community via platforms such as MISP, VirusTotal, or ISACs:
  - C2 IP: `92.63.8.47`
  - MD5: `f83fb9ce6a83da58b20685c1d7e1e546`
  - SHA256: `e8a091a84dd2ea7ee429135ff48e9f48f7787637ccb79f6c3eb42f34588bc684`
  - Filename: `Invoice.exe`
  - Malware Family: Maze Ransomware

---

## 7. Lessons Learned

- **Device Action = Allowed is a critical escalation flag.** When the endpoint agent permits malware execution without quarantine, it critically depends on the SOC analyst detecting and responding quickly. In this case, `Invoice.exe` ran successfully before being caught, leaving minimal time to contain it before encryption began. EDR tuning to improve pre-execution blocking of suspicious executables from user-writable paths (e.g., Downloads, Temp) is essential.
- **Phishing with invoice lures remains highly effective.** Maze ransomware exploited a common social engineering theme (a fake invoice) to get the user to execute a malicious `.exe` file. Security awareness training focused on recognizing malicious email attachments — especially executable files disguised as documents — would have prevented this incident.
- **Maze's double extortion model changes the incident response calculus.** Unlike traditional ransomware, Maze also exfiltrates data before encrypting it. This means even if files are restored from backup, there may still be a data breach with regulatory (GDPR, HIPAA, etc.) and reputational implications. Incident response playbooks must account for the data exfiltration component, not just file recovery.
- **Log correlation is decisive.** The C2 communication confirmation (HTTP POST from `10.15.15.18` to `92.63.8.47`) in log management was a critical step that removed any doubt and confirmed a true positive, allowing rapid escalation and containment decisions.
- **Shadow copy deletion is a ransomware red flag.** The early detection of `vssadmin delete shadows` or WMI-based shadow copy deletion should be treated as a high-priority indicator of active ransomware and trigger immediate automated isolation responses.

---

## Indicators of Compromise (IOCs)

| Type | Value |
|---|---|
| Sender Email | N/A (not captured in this alert) |
| Sender Domain | N/A (not captured in this alert) |
| SMTP Relay IP | N/A (not captured in this alert) |
| C2 IP | `92.63.8.47` |
| C2 Port | 80 (HTTP POST), 443 (HTTPS) |
| Attachment Name | `Invoice.exe` |
| Malware Name | Maze Ransomware |
| MD5 Hash | `f83fb9ce6a83da58b20685c1d7e1e546` |
| SHA256 Hash | `e8a091a84dd2ea7ee429135ff48e9f48f7787637ccb79f6c3eb42f34588bc684` |
| Malware Family | Maze (a.k.a. ChaCha Ransomware) |
| Mutex | N/A (not captured in this alert) |
| Persistence Path | `C:\Users\[User]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\` (startup folder — Maze persistence) |
| Victim Host IP | `10.15.15.18` |
| Victim User | `AdamPRD` |

---

## Notes
- Environment: Simulated SOC / Lab Environment
- This investigation was conducted for learning and skill development purposes.
